# PixelRotation 重建说明

## 1. 项目目的

本文件用于指导 目标Agent 在**无法查看我司源码**的前提下，重建 `PixelRotation` 产品本体。

重建目标是：

- 100% 还原当前 `PixelRotation` 已实现的功能行为。
- 不限制技术栈、语言、架构。
- 只按“对外行为与验收结果”判断是否达标。
- 下游职业脚本（如 `PriestDiscipline`）不是重建目标，只需给接入范例。

## 2. 项目整体逻辑

`PixelRotation` 位于两个开源上游与最终脚本之间，负责调度、决策调用、输入发送。

```mermaid
flowchart LR
    A[PixelAddonX2<br/>游戏内插件] -->|像素块| B[PixelDumperX2<br/>像素捕获与解析]
    B -->|JSON API| C[PixelRotation<br/>调度/配置/容错/输入发送]
    C -->|脚本基类与运行时| D[下游策略脚本]
```

职责边界（硬性）：

1. `PixelRotation` 仅通过 HTTP JSON API 读数据，不可直接读游戏内存。
2. 默认 API：`GET http://127.0.0.1:65131/api`，请求超时参数为 `1.0s`。
3. `PixelRotation` 不负责像素生成/捕获/解析（由上游负责）。
4. `PixelRotation` 负责主循环、容错、配置、GUI、按键发送、脚本承载。

### 2.1 验收环境与前置条件（强制）

1. 操作系统：Windows（与当前产品一致）。
2. 上游依赖：必须接入真实 `PixelDumperX2` JSON API 与真实游戏窗体，不允许只用 mock 完成最终验收。
3. 联调数据：验收时至少覆盖“正常数据、缺失字段、error 字段、请求失败”四类场景。
4. 验收记录：所有结论必须基于可复现证据，不接受口头“已实现”。

## 3. 模块一：循环调度与生命周期

### 3.1 功能说明

- `start()` 启动后台线程执行循环；重复调用无副作用。
- `stop()` 发出停止信号并等待线程回收（等待参数 `2.0s`）；重复调用无副作用。
- tick 间隔计算：
  - `base_interval = 1 / fps`
  - `interval = base_interval * random.uniform(1 - interval_jitter, 1 + interval_jitter)`
- 失败路径（请求失败/解析失败/返回 error）使用短退避：`interval / 5`。
- 策略函数异常必须被捕获并记录，循环不可中断。
- 验收前提：`main_rotation(data)` 必须无阻塞（不得包含长时间 I/O 或长等待），否则线程回收时限不成立。

### 3.2 模块验收指标（强制）

- [ ] 在 `main_rotation` 无阻塞前提下，启动后存在持续 tick，停止后线程可在 `2.2s` 内回收。
- [ ] 重复启动/停止不产生额外线程或异常。
- [ ] 失败路径采用 `interval/5`，成功路径采用 `interval`。
- [ ] 策略抛异常时循环持续运行。

## 4. 模块二：API 拉取与错误处理

### 4.1 功能说明

- 使用会话复用请求（等价于 `Session` 复用）。
- 每 tick 请求本地 API，请求超时参数固定 `1.0s`。
- 请求错误（网络/HTTP）或 JSON 解析错误：记日志并走短退避。
- 返回 JSON 含 `error` 字段：记日志并走短退避。

### 4.2 模块验收指标（强制）

- [ ] 超时配置值为 `1.0s`，实测触发时间容差 `±0.1s`。
- [ ] 请求失败、解析失败、`error` 字段三类错误都可观测到日志。
- [ ] 错误不会导致进程退出。

## 5. 模块三：数据适配（AttrDict/NoneObject）

### 5.1 功能说明

- 字典转点号访问对象，递归转换嵌套字典与列表内字典。
- 访问不存在键时返回占位对象（非抛异常）。
- 占位对象语义：
  - 任意属性访问返回自身；
  - 布尔值为假；
  - 可迭代为空；
  - 长度为 0；
  - 与 `None` 视为等价；
  - 使用单例。
- 缺失键在点号访问与下标访问两条路径均告警。

### 5.2 模块验收指标（强制）

- [ ] 深层链式访问缺失字段不抛异常。
- [ ] 缺失字段告警可观测。
- [ ] 列表中的嵌套字典被递归转换。

## 6. 模块四：配置系统与写入门禁

### 6.1 功能说明

- 预置配置项：
  - `fps`：`1~30`，步进 `1`，默认 `15`。
  - `interval_jitter`：`0.0~0.5`，步进 `0.05`，默认 `0.2`。
  - `spell_queue_window`：`0.1~0.5`，步进 `0.02`，默认 `0.2`。
- 数值配置写入规则：先 clamp，再按步进对齐（步进 `<=0` 仅 clamp）。
- 枚举配置支持索引和值读取；非法写入忽略。
- 枚举默认索引越界时，读取值返回空字符串（再由转换器处理）。
- 写入门禁：仅 GUI 事件路径可写；普通路径写入必须抛权限异常。
- 给不存在配置项赋值必须抛 `AttributeError`。
- 配置容器支持遍历全部项，用于 GUI 动态生成控件。

### 6.2 模块验收指标（强制）

- [ ] 三个默认配置项的范围、步进、默认值完全一致。
- [ ] 非 GUI 路径写配置必然抛权限异常。
- [ ] 给不存在配置项赋值时抛 `AttributeError`。
- [ ] 枚举默认索引越界时读取空字符串。
- [ ] 新增 `SliderConfig/ComboConfig` 配置项后 GUI 可自动渲染对应控件。

## 7. 模块五：动作映射与输入发送

### 7.1 功能说明

- `cast(target, spell)` 使用 `key = target + spell` 拼接映射键。
- 若映射不存在：记录告警，不中断循环。
- 发送前校验目标窗体句柄；无句柄时拒绝发送。
- 组合键发送规则：按顺序按下、等待 `10ms`、逆序抬起。
- 支持键范围（当前实现）：`CTRL/SHIFT/ALT` + `NUMPAD0~9` + `F1~F12`（含 `F4`）。

### 7.2 模块验收指标（强制）

- [ ] 映射键拼接规则与缺失映射告警行为一致。
- [ ] 未选择目标窗体时，发送被拒绝。
- [ ] 按下顺序与抬起逆序正确，按压间隔容差 `10ms ± 5ms`。

## 8. 模块六：GUI 与交互联动

### 8.1 功能说明

- 主窗口：置顶、无边框、固定宽度 `315`、不可手动缩放。
- 支持窗口拖动（主窗体与日志栏区域都可拖动）。
- 顶部控制区：启动/状态/停止/折叠。
- 配置区：动态渲染滑块/下拉，支持折叠。
- 点击启动后自动折叠配置区。
- 配置项说明支持快速 tooltip：鼠标进入立即显示，离开立即隐藏。
- 窗体来源：底层先枚举“可见且标题非空”窗口，GUI 再过滤标题含 `魔兽世界`。
- 运行态联动：运行中禁用启动、窗体选择、刷新、关闭；停止后恢复。
- 关闭保护：弹确认输入框，仅输入 `exit`（忽略大小写与首尾空格）才允许关闭；关闭前先 stop。
- 屏蔽 `Alt+F4` 直接关闭。
- 状态刷新定时器 `500ms`，验收容差 `±50ms`。

### 8.2 模块验收指标（强制）

- [ ] 未选择目标窗体时，启动按钮不可用。
- [ ] 运行态控件禁用规则与停止后恢复规则一致。
- [ ] 点击启动后，配置区自动折叠。
- [ ] tooltip 行为为“进入即显、离开即隐”。
- [ ] 关闭口令校验严格为 `exit` 规则，且先停后关。
- [ ] `Alt+F4` 无法直接关闭主窗口。

## 9. 模块七：日志链路与可观测性

### 9.1 功能说明

- 关键运行事件需同时到达：控制台 + GUI 单行日志。
- GUI 日志必须为纯文本（样式标签剥离后写入）。
- GUI 只显示最近一条消息。
- 至少可观测事件：施法成功、空闲原因、未命中映射、API 错误、策略异常。
- 启动/停止与按键发送失败日志允许仅控制台可见（与当前实现一致）。

### 9.2 模块验收指标（强制）

- [ ] GUI 日志不包含样式标签。
- [ ] 上述 5 类关键事件每类至少可观测 3 次，并可回放触发步骤。
- [ ] GUI 始终仅展示最近一条日志。

## 10. 强制功能验收总表（当前已实现，必须 100% 通过）

以下为**当前产品已实现能力**，目标Agent 必须全部通过：

- [ ] M-01 依赖边界正确：仅经 JSON API 读数据。
- [ ] M-02 默认 API 与超时一致：`http://127.0.0.1:65131/api` + 超时参数 `1.0s`。
- [ ] M-03 tick 间隔与 jitter 计算规则一致。
- [ ] M-04 三类错误（请求/解析/error 字段）均短退避 `interval/5`。
- [ ] M-05 数据容错语义（AttrDict/NoneObject）一致。
- [ ] M-06 配置门禁一致（仅 GUI 可写）。
- [ ] M-07 默认配置项参数（范围/步进/默认值）一致。
- [ ] M-08 配置边界行为一致（未知项赋值异常、枚举默认索引越界返回空字符串）。
- [ ] M-09 动作映射拼接与发送行为一致。
- [ ] M-10 键盘发送顺序一致（按下顺序、逆序抬起、`10ms ± 5ms`）。
- [ ] M-11 窗体筛选规则一致（可见+标题非空，再过滤 `魔兽世界`）。
- [ ] M-12 主窗口宽度固定 `315`，不可手动缩放。
- [ ] M-13 主窗体与日志栏均支持拖动窗口。
- [ ] M-14 运行态控件联动一致（启动/选择/刷新/关闭禁用，停止后恢复）。
- [ ] M-15 启动后自动折叠配置区。
- [ ] M-16 配置项 tooltip 快速提示行为一致（进入即显、离开即隐）。
- [ ] M-17 关闭确认一致（仅 `exit` 通过，且先 stop 再关）。
- [ ] M-18 `Alt+F4` 屏蔽一致。
- [ ] M-19 状态刷新定时器一致（`500ms ± 50ms`）。
- [ ] M-20 关键运行事件日志链路一致（控制台+GUI，GUI 去样式，仅一条）。

## 11. 整体验收指标（总闸门）

验收结论必须同时满足：

1. 第 10 章 `M-01 ~ M-20` 通过率 = `100%`。
2. 第 3~9 章模块验收项全部通过。
3. 验收在第 2.1 章规定的真实联调环境完成。
4. 第 13 章下游接入伪代码契约可在新产品上等价落地。
5. 建议增强指标（第 12 章）至少完成 `1` 项并通过对应验收。

若任一条不满足，则整体验收不通过。

### 11.1 证据交付格式（强制）

每个强制项必须提交至少一类证据，且可复验：

1. 录屏（含系统时间与操作步骤）。
2. 关键日志片段（含触发场景、时间戳、结果）。
3. 自动化或半自动测试脚本（含输入、期望、实测结论）。

未提交证据的条目视为未通过。

## 12. 建议增强指标（当前未实现，建议项；目标Agent 至少完成 1 项）

说明：本章为增量建议，不属于当前已实现功能；但为了提升可维护性，目标Agent 必须至少完成 1 项。

### R-01 API 地址可配置化

- 目标：API 地址不再硬编码，可通过配置或启动参数覆盖。
- 验收：在不改代码前提下，将地址改为新值后系统可正常拉取。

### R-02 键位表外置化

- 目标：支持通过外部配置扩展键位表，而非仅靠内置常量。
- 验收：新增一个当前未内置键位后，无需改核心代码即可发送成功。

### R-03 窗体过滤关键字可配置化

- 目标：GUI 的窗口标题过滤词从固定 `魔兽世界` 改为可配置。
- 验收：修改过滤词后，候选窗体列表实时按新关键字生效。

### R-04 GUI 日志历史与导出

- 目标：在保留单行最新日志展示的同时，增加可查看历史日志并导出文件。
- 验收：连续产生 100 条日志后可检索历史，并可导出为文本文件。

## 13. 下游 rotation 伪代码（20 行以内示例）

```text
class DemoEngine extends RotationEngine
  init():
    super.init()
    config.add(slider("heal_threshold", 20, 80, 5, 45))
    set_macro("targetSkillA", "ALT-NUMPAD1")
    set_macro("party1SkillB", "SHIFT-F2")
  main_rotation(data):
    if data.player.status.unit_is_dead_or_ghost: return idle("dead")
    if not data.player.status.unit_in_combat: return idle("out_of_combat")
    if data.party1.status.exists and data.party1.status.unit_health < config.heal_threshold:
      return cast("party1", "SkillB")
    if data.target.status.exists and data.target.status.unit_in_range and data.target.status.unit_can_attack:
      return cast("target", "SkillA")
    return idle("no_action")
engine = DemoEngine(); engine.run()
```
