# 牧师戒律专精 - 治疗优先级逻辑（主干）

## 核心决策流程（每帧执行）

```
main_rotation():
    1. 职业/专精检查（必须是牧师+戒律）
    
    2. 基础状态检查（坐骑、载具、聊天框、死亡、施法中、进食饮水）
    
    3. 获取战斗环境参数：
       - 自动选择敌人目标（focus > target）
       - 计算小队健康评分（含血量、减益、职责权重）
       - 获取玩家/坦克/最低血量单位状态
       - 检测AOE窗口期（即将到来 / 正在进行）
       - 获取技能CD状态（苦修、盾、耀等）
       - 计算无救赎角色列表
    
    4. 按优先级顺序决策（返回第一个满足条件的动作）
```

---

## 优先级列表（从高到低）

### P0. 基础阻断检查
```
如果 职业≠牧师 或 专精≠戒律:
    返回 空闲("专精不匹配")

如果 在坐骑上 / 在载具中 / 聊天框打开 / 已死亡 / 正在施法 / 进食饮水中:
    返回 空闲("状态阻断")
```

---

### P1. 非战斗逻辑
```
如果 不在战斗中:
    如果 任一人耐力<5分钟:
        返回 Cast("耐力")
    
    如果 启用非战斗治疗:
        如果 苦修可用 且 存在最低分单位:
            返回 Cast("最低分单位 苦修")
        
        如果 盾可用 且 存在盾剩余最少单位:
            返回 Cast("盾最少单位 盾")
    
    返回 空闲("不在战斗中")
```

---

### P2. 自我保命（优先级最高）
```
如果 自身血量 < SelfHealScore(45%):
    如果 绝望祷言可用:
        返回 Cast("绝望祷言")

如果 自身血量 < FadeHealScore(85%) 且 渐隐术启用:
    如果 渐隐术可用:
        返回 Cast("渐隐术")
```

---

### P3. 大招：福音
```
如果 福音可用:
    计算当前救赎覆盖人数
    计算每人分摊治疗量 = 福音总治疗量 / 救赎人数
    如果 ≥3人治疗缺口 < 分摊治疗量（不会过量）:
        返回 Cast("福音")
```

---

### P4. AOE预兆爆发
```
如果 处于AOE期间 且 预兆总层数==2:
    返回 Cast("预兆")
```

---

### P5. AOE自我套盾
```
如果 AOE即将到来 或 正在进行:
    如果 自身无盾:
        返回 Cast("player盾")
```

---

### P6. AOE补救赎（预铺）
```
如果 AOE即将到来 或 正在进行:
    如果 ≥2人无救赎 且 耀可用:
        返回 Cast("耀")
    
    如果 ≥1人无救赎:
        返回 Cast("无救赎单位[1] 恢复")
```

---

### P7. 驱散逻辑
```
如果 纯净术可用:
    遍历寻找需驱散单位:
        如果 存在秒驱级Debuff:
            返回 Cast("该单位 纯净术")
        
        如果 存在爆炸Debuff 且 队伍最低血量>80%:
            返回 Cast("该单位 纯净术")
        
        如果 存在普通魔法Debuff 且 队伍最低血量>30%:
            返回 Cast("该单位 纯净术")
```

---

### P8. 耀充能不浪费
```
如果 耀充能>1层:
    如果 ≥2人无救赎:
        返回 Cast("耀")
    
    如果 ≥3人治疗缺口>耀治疗量:
        返回 Cast("耀")
```

---

### P9. 祸福相依盾
```
如果 盾可用 且 祸福相倚层数≥3 且 无洞察预兆buff:
    返回 Cast("盾剩余最少单位 盾")
```

---

### P10. 苦修（核心治疗/输出）
```
如果 苦修可用:
    如果 最低血量非T单位血量 < DefensivePenanceScore(75%):
        返回 Cast("该单位 苦修")
    
    如果 坦克血量 < TankPenanceScore(50%):
        返回 Cast("坦克 苦修")
    
    如果 存在敌人目标:
        返回 Cast("敌人目标 苦修")
```

---

### P11. 圣光涌动瞬发快疗
```
如果 圣光涌动层数>0:
    如果 自身血量 < HealSelfScore+LightningScore:
        返回 Cast("player快速治疗")
    
    如果 最低血量单位血量 < FlashHealScore+LightningScore:
        返回 Cast("该单位 快速治疗")
```

---

### P12. 自我快速治疗
```
如果 自身血量 < HealSelfScore(80%) 且 不在移动中:
    返回 Cast("player快速治疗")
```

---

### P13. 坦克恢复维护
```
如果 坦克恢复剩余时间<1秒:
    返回 Cast("坦克 恢复")
```

---

### P14. 常规补救赎
```
如果 ≥1人无救赎:
    返回 Cast("无救赎单位[1] 恢复")
```

---

### P15. 输出：上痛
```
如果 敌人目标存在 且 目标无暗言术：痛:
    返回 Cast("敌人目标 痛")
```

---

### P16. 灌注
```
如果 灌注可用 且 无洞察预兆buff:
    目标 = 伤害最高队友（从Details获取）
    返回 Cast("目标 灌注")
```

---

### P17. 暗影魔
```
如果 敌人目标存在 且 暗影魔可用:
    如果 处于AOE期间 或 AOE即将到来 或 点了摧心魔天赋:
        如果 无洞察预兆buff:
            返回 Cast("敌人目标 暗影魔")
```

---

### P18. 心灵震爆
```
如果 敌人目标存在 且 心灵震爆可用:
    如果 不在移动中 且 无洞察预兆buff:
        返回 Cast("敌人目标 心灵震爆")
```

---

### P19. 灭（斩杀）
```
如果 敌人目标存在 且 灭可用 且 点了天赋:
    如果 无洞察预兆buff 且 目标血量<20%:
        返回 Cast("敌人目标 灭")
```

---

### P20. 快速治疗填充（紧急）
```
如果 启用快速治疗 或 处于AOE期间:
    如果 最低血量单位血量 < FlashHealScore(70%):
        返回 Cast("该单位 快速治疗")
```

---

### P21. 惩击填充（默认输出）
```
如果 祸福相倚层数≤2 且 不在移动中:
    返回 Cast("敌人目标 惩击")
```

---

### P22. 最后的快速治疗检查
```
如果 启用快速治疗:
    如果 最低血量单位血量 < FlashHealScore:
        返回 Cast("该单位 快速治疗")
```

---

### P23. 空闲
```
返回 空闲("无事可做")
```

---

## 关键机制说明

| 机制 | 说明 |
|------|------|
| **救赎系统** | 通过盾/恢复/耀施加救赎buff，伤害转化为治疗 |
| **祸福相倚** | 每层使下一个苦修伤害+10%，最多6层，通过盾触发 |
| **预兆系统** | 洞察(减CD)/虔诚(增疗+过量转移)/慰藉(护盾+减伤)/远见(三合一) |
| **圣光涌动** | 快速治疗变为瞬发，优先用于移动中或紧急治疗 |
| **AOE窗口** | 通过监听怪物施法预判AOE，提前铺救赎/套盾 |
| **健康评分** | 基础血量 + 职责权重(TANK+0.2) + 职业权重 + 减益惩罚 |

---

## 治疗评分公式

```
healthScore = (当前血量 - 治疗吸收盾 + 预治疗) / 最大血量
            + 职责权重(TANK+0.2, HEALER-0.02)
            + 职业权重
            - 高伤害Debuff×20
            - 中伤害Debuff×10