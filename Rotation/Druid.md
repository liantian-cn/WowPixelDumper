# 德鲁伊恢复专精 - 治疗优先级逻辑（主干）

## 核心决策流程（每帧执行）

```
Decide(frame, nowSec):
    1. 更新血量趋势追踪器
    
    2. 如果在施法中 → 返回空闲（跳过本帧）
    
    3. 筛选有效目标（存活+在范围内）
    
    4. 预扫描队伍状态：
       - 统计 <95%、<90%、<60% 人数
       - 找出濒死目标（<30% 且血量最低）
    
    5. 按优先级顺序决策（返回第一个满足条件的动作）
```

---

## 优先级列表（从高到低）

### P0. 施法中检测
```
如果 自身正在施法:
    返回 空闲("施法中...")
```

---

### P1. 生命绽放(LB) - 固定目标维护
```
条件:
    - 固定目标有效（在范围内、存活）
    - 无人濒死（让位给紧急救人）
    - 目标身上没有LB
    - 不在保护期内
    - 距离上次施放间隔 ≥ LB_MinIntervalSec
    - 无待确认的LB施法

动作:
    施放 Lifebloom → 固定目标
    设置待确认状态，等待buff确认
```

---

### P2. 回春术(REJUV) - 安全期铺盖
```
条件:
    - 全员血量 ≥ 90%（安全期）
    - 存在血量 <100% 且没有回春的目标
    - 满足防抖间隔

动作:
    选择血量最低且无回春的目标
    施放 Rejuvenation
    记录施放时间戳
```

---

### P3. 濒死紧急处理（<30%）
```
条件:
    - 存在血量 <30% 的目标

子优先级:
    a) 如果 迅捷治愈不在CD:
         施放 Swiftmend → 濒死目标
         
    b) 否则:
         施放 Regrowth（硬读条）→ 濒死目标
```

---

### P4. 野性成长(WG) - 群刷（高优先级）
```
条件:
    - (≥3人血量<90%) 或 (≥2人血量<60%)
    - WG不在CD

动作:
    目标选择:
        - 优先LB固定目标（如果有效）
        - 否则选血量最低的人
    
    施放 WildGrowth → 选定目标
```

---

### P5. 迅捷治愈(EMG) - 常规使用
```
条件:
    - EMG不在CD
    - 距离上次施放 ≥ EMG_MinIntervalSec
    - 存在满足触发条件的目标:
        * 血量 <60% 或
        * 掉血速度 ≥4.0 或
        * 血量 <30%（濒死）
    - 目标身上有HoT（回春/愈合/野性成长）

目标选择策略:
    优先选身上HoT数量最多的目标（延长收益最大）

动作:
    施放 Swiftmend → 选定目标
    更新施放时间戳
    （自动获得丛林之魂buff，由P6检测消费）
```

---

### P6. 顺劈消费 - 丛林之魂buff
```
条件:
    - 自身有丛林之魂buff

子优先级:
    a) 愈合顺劈（优先）:
         如果 存在血量 <88% 的目标:
              施放 Regrowth → 评分最高目标（治两人）
    
    b) 回春顺劈:
         如果 存在血量 <95% 且无回春的目标:
              施放 Rejuvenation → 血量最低目标（铺两人）

注: 没有合适目标时，让buff自然过期，不强制消费
```

---

### P7. 愈合(REG) - 单刷
```
条件:
    - 存在血量 <88% 的目标

评分公式（每帧重新计算）:
    score = (100 - 血量) + 掉血速度×8 + (无回春+10)

动作:
    选择score最高的目标
    施放 Regrowth
```

---

### P8. 野性成长(WG) - 稳定兜底
```
条件:
    - WG不在CD
    - 低血量人数 ≥ WG_GroupLowCnt（默认2人）
    - 掉血速度条件满足（如果启用）

动作:
    同P4的目标选择逻辑
    施放 WildGrowth
```

---

### P9. 空闲等待
```
返回 空闲（不施法，等待下一帧）
```

---

## 关键机制说明

| 机制 | 说明 |
|------|------|
| **LB确认机制** | 发出施法后等待buff确认（0.35秒窗口），防止延迟导致的重复施法 |
| **LB保护期** | 确认成功后12秒内不再施放（LB持续15秒） |
| **丛林之魂** | 迅捷治愈后获得的buff，使下一个愈合/回春治疗两个目标 |
| **EMG延长HoT** | 天赋版迅捷治愈不消耗HoT，反而延长所有HoT 8秒 |
| **防抖控制** | 各技能有独立的施放间隔限制，避免频繁刷新 |